o<m21> sub

; Move Carousel to the tool change position - OUT
; then unload any tool in the spindle into the current pocket
; Parameter #3991 is used to track the current tool loaded it in the spindle (persistently)
; #<atc_z_tool_change_height> is the height you spindle needs to be at to clamp/unclamp a tool form the ATC (Set via INI [ATC]Z_TOOL_CHANGE_HEIGHT)
; #<atc_z_tool_clearance_height> is the clearance height you spindle needs to be at to safely clear the ATC (Set via INI [ATC]Z_TOOL_CLEARANCE_HEIGHT)
; #<atc_x_tool_change_pos> is the X position for tool change (Set via INI [ATC]X_TOOL_CHANGE_POS)
; #<atc_y_tool_cha
nge_pos> is the Y position for tool change (Set via INI [ATC]Y_TOOL_CHANGE_POS)
(PRINT, o<m21> - Tool unload from spindle)

; Load Z parameters from INI
#<atc_z_tool_change_height> = -3.9000
o100 if [EXISTS[#<_ini[atc]z_tool_change_height>]]
    #<atc_z_tool_change_height> = #<_ini[atc]z_tool_change_height>
o100 endif
#<atc_z_tool_clearance_height> = [#<_ini[AXIS_Z]MAX_LIMIT>-0.01]
o110 if [EXISTS[#<_ini[atc]z_tool_clearance_height>]]
    #<atc_z_tool_clearance_height> = #<_ini[atc]z_tool_clearance_height>
o110 endif

; Load X parameter from INI
#<atc_x_tool_change_pos> = -20.0000
o120 if [EXISTS[#<_ini[atc]x_tool_change_pos>]]
    #<atc_x_tool_change_pos> = #<_ini[atc]x_tool_change_pos>
o120 endif

; Load Y parameter from INI
#<atc_y_tool_change_pos> = -10.0000
o130 if [EXISTS[#<_ini[atc]y_tool_change_pos>]]
    #<atc_y_tool_change_pos> = #<_ini[atc]y_tool_change_pos>
o130 endif

M5 M9 ; Stop spindle and coolant
G90

; Call retractatc subroutine to ensure carousel is retracted before we begin
(debug, Ensuring carousel is retracted before starting tool unload)
o<retractatc> call
o132 if [#5399 EQ 0]
    (debug, WARNING: Initial carousel retraction check failed)
    (abort, Failed to confirm carousel retracted position - cannot proceed safely)
o132 endif

; First move Z to safe clearance height
G0 G53 Z#<atc_z_tool_clearance_height> 

; Then move X,Y to tool change position
G0 G53 X#<atc_x_tool_change_pos> Y#<atc_y_tool_change_pos>

; Ensure spindle is oriented before extending ATC
M5 ; Ensure spindle is stopped
G4 P1.0 ; Dwell for spindle to stop completely
o<orientspindle> call
o135 if [#5399 EQ 0]
   (debug, WARNING: Spindle orientation failed)
   (abort, Failed to orient spindle - cannot proceed with tool unload)
o135 endif

; Then move Z to tool change height
G0 G53 Z#<atc_z_tool_change_height> ; move to tool change height

; Call extendatc subroutine to extend carousel
(debug, Extending ATC carousel for tool unload)
o<extendatc> call
o140 if [#5399 EQ 0]
    (debug, WARNING: ATC extension failed)
    (abort, Failed to extend ATC carousel - cannot proceed with tool unload)
o140 endif

; Call unclamptool subroutine to release the tool
(debug, Unclamping tool for storage in carousel)
o<unclamptool> call
o145 if [#5399 LT 0]
    (debug, WARNING: Tool unclamp failed)
    (abort, Failed to unclamp tool - cannot complete tool storage)
o145 endif

; Move Z to clearance height
G0 G53 Z#<atc_z_tool_clearance_height>

#3991 = 0; save fact there is now no tool in the spindle

(debug, CAROUSEL TRACKING - After operation, position: #3990)

(PRINT, o<m21> - Tool unloading complete)
o<m21> endsub [1]

M2

