o<orientspindle> sub

; First ensure spindle is stopped
M5
G4 P0.25  ; Dwell for 0.5 seconds to ensure spindle has stopped

; ----- TOOL CLAMP STATUS CHECK AND CLAMPING -----
; Debug message to help track execution
;(debug, Checking tool clamp status...)

; SAFETY CHECK: Verify tool is clamped before orientation
M66 P5 L0 ; Read tool clamp status
(debug, Initial clamp status reading: #5399)

o110 if [#5399 EQ 0]
    (msg, Tool not clamped. Activating clamp routine.)
    ;(debug, Calling clamptool subroutine...)
    
    ; Force tool clamp - with explicit error checking
    o<clamptool> call
    
    ; Dwell to ensure clamp operation completes
    G4 P1.0
    
    ; Re-check clamp status after attempting to clamp
    M66 P5 L0
    (debug, Clamp status after clamptool: #5399)
    
    ; Verify clamp was successful
    o115 if [#5399 EQ 0]
        (msg, ERROR: Failed to clamp tool. Aborting spindle orientation.)
        (debug, Tool clamp failure - orientation aborted)
        o<orientspindle> return [0]
    o115 endif
    
    (debug, Tool clamp successful)
o110 endif

; ----- SECONDARY VERIFICATION -----
; Double-check tool is clamped regardless of first check
M66 P5 L0
o120 if [#5399 EQ 0]
    (msg, ERROR: Tool is still not clamped. Cannot orient spindle safely.)
    (debug, Secondary clamp check failed - aborting)
    o<orientspindle> return [0]
o120 endif

; ----- SPINDLE ORIENTATION -----
;(debug, Tool confirmed clamped, proceeding with spindle orientation)
M19 R0 ; Orient spindle to 0 degrees

; First check if spindle is oriented
M66 P6 L0 ; Check spindle orientation sensor (immediate read, no waiting)
o130 if [#5399 EQ 0]
    (msg, ERROR: Spindle must be oriented before releasing tool)
    (debug, SAFETY ERROR: Spindle not oriented. Tool release aborted.)
    o<m24> return [-1]
o130 endif

; Double check - make extra sure spindle is oriented
;(debug, Spindle orientation detected, confirming stability...)
G4 P0.2 ; Small dwell to ensure signal is stable
M66 P6 L0 ; Check again
o131 if [#5399 EQ 0]
    (msg, ERROR: Unstable spindle orientation detected)
    (debug, SAFETY ERROR: Unstable orientation. Tool release aborted.)
    o<m24> return [-1]
o131 endif

;(debug, Spindle orientation complete)
o<orientspindle> endsub [1]

M2